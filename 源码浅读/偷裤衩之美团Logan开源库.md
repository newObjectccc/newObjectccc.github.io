# **ã€å·è£¤è¡©ã€‘ç¾å›¢Loganåº“**

ğŸ‘‰ å¼•è¨€ï¼š```è¿™æ˜¯ä¸€ä¸ªæºç å…±è¯»çš„ç³»åˆ—æ–‡ç« ï¼Œæˆ‘ç®¡å®ƒå«å·è£¤è¡©ï¼Œé¡¾åæ€ä¹‰ï¼Œéå¸¸å½¢è±¡ï¼Œå¦™ä¸å¯è¨€ï¼Œä¸å¯å¤šè¨€ï¼Œå›å‘³æ— ç©·ã€‚```

1. *ç®€å•èŠä¸€ä¸‹ã€å·è£¤è¡©ã€‘çš„ä»·å€¼ï¼š*

- **ä¿ƒè¿›æ·±å…¥ç†è§£**: é€šè¿‡é›†ä½“è®¨è®ºå’Œåˆ†äº«ç»éªŒï¼ŒåŠ æ·±å¯¹æºç çš„ç†è§£
- **æé«˜ç¼–ç æŠ€å·§**: å­¦ä¹ ä»–äººçš„å¼€å‘æ€è·¯å’ŒæŠ€å·§ï¼Œæ‹“å®½è‡ªå·±çš„æ€ç»´æ–¹å¼ï¼Œæ˜¯çœŸçš„å¯ä»¥å­¦åˆ°å¾ˆå¤šéªšæ“ä½œ
- **äº’ç›¸å­¦ä¹ é˜…è¯»æºç æŠ€å·§**: é˜…è¯»æºç æœ¬èº«ä¹Ÿæ˜¯éœ€è¦ä¸€å®šæŠ€å·§çš„ï¼Œå’Œç»éªŒçš„ã€‚
- **å¯èƒ½ç»™å¼€æºç¤¾åŒºè´¡çŒ®ä»£ç **: å½“ä½ é˜…è¯»å®Œæºç ï¼Œæˆ–é€”ä¸­çš„ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥ç»™å¼€æºç¤¾åŒºæissueï¼Œç”šè‡³æ˜¯PRï¼Œè‹¥è¢«ç»´æŠ¤è€…Mergedï¼Œé‚£ä½ ä¾¿æˆä¸ºäº†å¼€æºç¤¾åŒºè´¡çŒ®è€…ã€‚

2. *ç®€å•èŠä¸€ä¸‹ã€å·è£¤è¡©ã€‘çš„æ­¥éª¤ï¼š*

- **é€‰æ‹©æºç **: é€‰æ‹©ä¸€ä¸ªå¯¹è‡ªå·±æœ‰ä»·å€¼æˆ–æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®
- **åˆ†ææºç ç»“æ„**: ç†è§£é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€æ¨¡å—åˆ’åˆ†åŠä¾èµ–å…³ç³»
- **è§£è¯»æ ¸å¿ƒä»£ç **: æ·±å…¥ç ”ç©¶å…³é”®çš„æ ¸å¿ƒä»£ç å®ç°ï¼Œé˜…è¯»å’Œç†è§£æºç æ³¨é‡Š
- **æå‡ºé—®é¢˜å’Œè®¨è®º**: åœ¨å…±è¯»å°ç»„ä¸­æå‡ºç–‘é—®å¹¶ä¸å…¶ä»–æˆå‘˜è¿›è¡Œè®¨è®ºï¼Œåˆ†äº«è‡ªå·±çš„ç†è§£å’Œè§£å†³æ–¹æ¡ˆ
- **å®è·µå’Œæ”¹è¿›**: å°†å­¦åˆ°çš„çŸ¥è¯†åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­ï¼Œå¹¶å°†æ”¹è¿›çš„å»ºè®®åé¦ˆç»™å¼€æºé¡¹ç›®çš„ç»´æŠ¤è€…

okkï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™æ¬¡çš„è£¤è¡©~

### ç¾å›¢Logan

![](https://camo.githubusercontent.com/c9414bd5708e8b65ba4384fe4d1f6779a11df3fcec79d3a818cff8a99478f7cd/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d627269676874677265656e2e7376673f7374796c653d666c6174)

![](https://camo.githubusercontent.com/1f37732e708ac323de48b7f41e2f575174df9ccffc177454c0221daec3ac8c4e/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f72656c656173652f4d65697475616e2d4469616e70696e672f4c6f67616e2e7376673f6d61784167653d323539323030303f7374796c653d666c61742d737175617265)

![](https://camo.githubusercontent.com/b0ad703a46e8b249ef2a969ab95b2cb361a2866ecb8fe18495a2229f5847102d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f5052732d77656c636f6d652d627269676874677265656e2e737667)

![](https://camo.githubusercontent.com/59dd5000f9d673013198051ef2a13747fa959a18159ee53960e63f9b868dc546/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f506c6174666f726d2d253230694f53253230253743253230416e64726f69642532302d627269676874677265656e2e737667)

>Logan æ˜¯ç¾å›¢ç‚¹è¯„é›†å›¢æ¨å‡ºçš„å¤§å‰ç«¯æ—¥å¿—ç³»ç»Ÿã€‚åç§°æ˜¯ Log å’Œ An çš„ç»„åˆï¼Œä»£è¡¨ä¸ªä½“æ—¥å¿—æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é‡‘åˆšç‹¼å¤§å”çš„å¤§åã€‚

#### Loganæ€»è§ˆ

>Logan å¼€æºçš„æ˜¯ä¸€æ•´å¥—æ—¥å¿—ä½“ç³»ï¼ŒåŒ…æ‹¬æ—¥å¿—çš„æ”¶é›†å­˜å‚¨ï¼Œä¸ŠæŠ¥åˆ†æä»¥åŠå¯è§†åŒ–å±•ç¤ºã€‚æˆ‘ä»¬æä¾›äº†äº”ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬ç«¯ä¸Šæ—¥å¿—æ”¶é›†å­˜å‚¨ ã€iOS SDKã€Android SDKã€Web SDKï¼Œåç«¯æ—¥å¿—å­˜å‚¨åˆ†æ Serverï¼Œæ—¥å¿—åˆ†æå¹³å° LoganSiteã€‚å¹¶ä¸”æä¾›äº†ä¸€ä¸ª Flutter æ’ä»¶Flutter æ’ä»¶

#### æ•´ä½“æ¶æ„

![](https://camo.githubusercontent.com/a73d7ec02c73fb1b0595dbca7c712019964542e0340ad3006bc576662162a0a6/68747470733a2f2f6d73732d73686f6e2e73616e6b7561692e636f6d2f76312f6d73735f37643663643834623532643534333234386262623733346162643339326539612f6c6f67616e2d6f70656e2d736f757263652f6c6f67616e5f617263682e706e67)

>ğŸ‘‰Loganä»“åº“åœ°å€ï¼š [Logan](https://github.com/Meituan-Dianping/Logan)

æˆ‘ä»¬è¿™æ¬¡è¦å·çš„ç›®æ ‡å°±æ˜¯ WebSDK

![](https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/d64e46c33623e5c6c66f0bf09ba9a1dcf750d7a2ad8ee7b539cd2d6399b3fd039c2e76916ddc12f2251ed0c39f525fbb?pictype=scale&from=30113&version=3.3.3.3&fname=dddffff.png&size=750)

å„ä½å¯ä»¥è‡ªè¡Œ clone æˆ–è€…åœ¨çº¿é˜…è¯»ï¼Œæ¨èä½¿ç”¨éå®˜æ–¹çš„ 1s é˜…è¯»ï¼Œ
>ä¹Ÿå°±æ˜¯åœ¨ <https://github.com/Meituan-Dianping/Logan> çš„ github åŸŸåååŠ  1s å³å¯ï¼Œlike this <https://github1s.com/Meituan-Dianping/Logan>

ä»‹ç»å®Œæ¯•ï¼Œå¼€å·ğŸ˜~

### WebSDK

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹ç›®å½•ç»“æ„~
![](https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/bcb58f68fc99baa428a0bf6610089b911ceac116673c24ef3bbdf1b62b207a358ecb69130348d237300fbdc9fc9ae069?pictype=scale&from=30113&version=3.3.3.3&fname=xxxx.png&size=750)

- **demo**é‡Œæ˜¯ä¸€ä¸ªdemoç¤ºä¾‹
- **img**é‡Œæ˜¯ä¸€äº›é™æ€èµ„æº
- **src**é‡Œæ˜¯WebSdkçš„æ ¸å¿ƒä»£ç 

>`demo`

æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆçœ‹çœ‹`demo`é‡Œé¢æ˜¯å¦‚ä½•ä½¿ç”¨Logançš„~

![](https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/6fea323026083526b2c376cd626a53f56fcd47901f847e247d790ca88347d2ebee72d1bc60ed1e0723a0fb12df360764?pictype=scale&from=30113&version=3.3.3.3&fname=ssssdddd.png&size=750)

å¯ä»¥çœ‹åˆ°å°±æ˜¯é€šè¿‡scriptæ ‡ç­¾æ³¨å…¥çš„SDK~ï¼ˆjsç›®å½•ä¸‹å°±æ˜¯æ‰“åŒ…åçš„äº§ç‰©ï¼‰
å¹¶è¿›è¡Œäº†åˆå§‹åŒ–(Logan.initConfig)ï¼Œå®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼Œéƒ½æ˜¯ä½¿ç”¨Loganè¿™ä¸ªç±»æ¥å®ç°çš„ã€‚
okkï¼ŒçŸ¥é“äº†æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œæˆ‘ä»¬å†æ¥å¾€ä¸‹çœ‹

>`src`

æˆ‘ä»¬æ¥çœ‹çœ‹æ ¸å¿ƒä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘åˆ æ‰äº†ä¸€äº›éæ ¸å¿ƒçš„ä»£ç å’Œæ³¨é‡Š

```typescript
// index.ts

import {
    LogEncryptMode,
    ReportConfig,
    GlobalConfig,
    LogConfig
} from './interface';
import Config from './global-config';
import { isValidDay } from './lib/utils';
import { ResultMsg, ReportResult } from './interface';
import LogManager from './log-manager';
import { Promise as ES6Promise } from 'es6-promise';
if (!window.Promise) {
    // @ts-ignore
    window.Promise = ES6Promise;
}
let logQueueBeforeLoad: LogConfig[] = [];

async function logAsync (logItem: LogConfig): Promise<void> {
    // No need to async import if tryTimes exceeds.
    if (LogManager.canSave()) {
        try {
            const saveLogModule = await import(
                /* webpackChunkName: "save_log" */ './save-log'
            );
            saveLogModule.default(logItem);
        } catch (e) {
            LogManager.errorTrigger();
            await (Config.get('errorHandler') as Function)(e);
        }
    } else {
        await (Config.get('errorHandler') as Function)(new Error(ResultMsg.EXCEED_TRY_TIMES));
    }
}

function logIfLoaded (logItem: LogConfig): void {
    if (
        !document.readyState ||
        (document.readyState && document.readyState === 'complete')
    ) {
        logAsync(logItem);
    } else {
        logQueueBeforeLoad.push(logItem);
    }
}

function standardLog (content: string, logType: number, encryptVersion: LogEncryptMode): never | void {
    try {
        logParamChecker(logType, LogEncryptMode.PLAIN);
    } catch (e) {
        (Config.get('errorHandler') as Function)(e);
    }
    logIfLoaded({
        logContent: logContentWrapper(content, logType),
        encryptVersion
    });
}

function onWindowLoad (): void {
    logQueueBeforeLoad.forEach(logItem => {
        logAsync(logItem);
    });
    logQueueBeforeLoad = [];
    window.removeEventListener('load', onWindowLoad);
}
window.addEventListener('load', onWindowLoad);

export function initConfig (globalConfig: GlobalConfig): void {
    Config.set(globalConfig);
}

export function log (content: string, logType: number): void {
    standardLog(content, logType, LogEncryptMode.PLAIN);
}

export function logWithEncryption (content: string, logType: number): void {
    standardLog(content, logType, LogEncryptMode.RSA);
}

export function customLog (logConfig: LogConfig): void {
    logIfLoaded({
        logContent: logConfig.logContent,
        encryptVersion: logConfig.encryptVersion
    });
}

export async function report (reportConfig: ReportConfig): Promise<ReportResult> {
    reportParamChecker(reportConfig);
    const reportLogModule = await import(
        /* webpackChunkName: "report_log" */ './report-log'
    );
    return await reportLogModule.default(reportConfig);
}

export default {
    initConfig,
    log,
    logWithEncryption,
    report,
    customLog,
    ResultMsg
};

```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºlogæ—¥å¿—ï¼Œå¤§æ¦‚æœ‰ä¸‰ç±»ï¼Œç”±ä¸‰ä¸ªæ–¹æ³•ç”Ÿæˆï¼š

1. **log** æ–¹æ³•ï¼šä¸€èˆ¬æ—¥å¿—
2. **logWithEncryption** æ–¹æ³•ï¼šåŠ å¯†æ—¥å¿—
3. **customLog** æ–¹æ³•ï¼šè‡ªå®šä¹‰æ—¥å¿—

å…¶ä¸­1,2éƒ½æ˜¯ç”¨standardLogæ–¹æ³•æ¥éªŒè¯logæ—¥å¿—è§„èŒƒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰æ ¼å¼ä¸Šçš„çº¦æŸã€‚

--------------------------

 ğŸ˜é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ª index.ts ä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ä¸€äº›é¢å¤–çš„çŸ¥è¯†ï¼š

- **çŸ¥è¯†ç‚¹**ï¼š```/*webpackChunkName: "repot_log"*/```ï¼Œ ç”¨äºwebpackåˆ†åŒ…çš„åŒ…åå®šä¹‰ï¼Œå¯ä»¥åœ¨ç›®å½•demo/js/ä¸‹æ‰¾åˆ°report_log.[chunkhash].jsä¸ºéªŒè¯ã€‚
- **çŸ¥è¯†ç‚¹**: ```document.readyState```ï¼Œè¿™ä¸ªå±æ€§æè¿°äº†```document```çš„åŠ è½½çŠ¶æ€ï¼ŒçŠ¶æ€å˜åŒ–ä¼šè§¦å‘readystatechangeäº‹ä»¶ï¼Œå®ƒæœ‰3ä¸ªå€¼ï¼Œ```loading```ï¼ˆåŠ è½½ä¸­ï¼‰ï¼Œ```interactive```ï¼ˆå¯äº¤äº’ï¼‰ï¼Œ```complete```ï¼ˆå®Œæˆï¼‰ï¼Œä¸è¦å’Œ```load```äº‹ä»¶æ··ä¸ºä¸€è°ˆå“ˆã€‚[è¯¦æƒ…è§MDN](https://developer.mozilla.org/en-US/docs/Web/API/Document/readyState)
- **çŸ¥è¯†ç‚¹**: ```const saveLogModule = await import('./report-log')```ï¼ŒåŠ¨æ€å¼•å…¥ï¼Œå°±æ˜¯åœ¨éœ€è¦çš„æ—¶å€™å¯¼å…¥æ¨¡å—ï¼Œä½†æ˜¯ä½¿ç”¨éœ€è¦æ³¨æ„ä¸€äº›ç»†èŠ‚ï¼Œæ¯”å¦‚ï¼š1.ä»–å¯èƒ½ä¼šè®©tree shakingå¤±æ•ˆï¼Œé™æ€å¼•å…¥æ›´å®¹æ˜“tree shakingã€‚2.å®ƒå¯ä»¥åœ¨ä¸»çº¿ç¨‹ï¼Œå…±äº«å·¥ä½œçº¿ç¨‹æˆ–ä¸“ä¸šæˆ–ä¸“ç”¨å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œä¸èƒ½åœ¨Service Workerå’Œ[worklet](https://developer.mozilla.org/en-US/docs/Web/API/Worklet)ä¸­ä½¿ç”¨ã€‚

--------------------------

æ¥å›å’±ä»¬çš„ä¸»é€»è¾‘ï¼Œå…¶å®ä¸»è¦å°±æ˜¯ç”Ÿæˆlogå’Œä¸ŠæŠ¥logè¿™ä¸¤ä¸ªæ–¹é¢ï¼Œæ¥ä¸Šé¢çš„ä¸‰ç±»logï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å…³äºæ—¥å¿—ä¸ŠæŠ¥è¿™ç±»çš„ä¸šåŠ¡ï¼Œå¿…ç„¶æ¶‰åŠåˆ°äº†æ—¥å¿—çš„ç”Ÿæˆå’Œä¿å­˜ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»çœ‹äº†logç”Ÿæˆæœ‰3ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•æ¥çœ‹çœ‹Loganå†…éƒ¨æ˜¯æ€ä¹ˆä¿å­˜logçš„ï¼Œåœ¨index.tsä¸­æˆ‘ä»¬èƒ½è¿½æº¯åˆ°çš„ä»£ç å°±æ˜¯```logIfLoaded```è¿™ä¸ªæ–¹æ³•ã€‚

```typescript
// index.ts

function logIfLoaded (logItem: LogConfig): void {
    if (
        !document.readyState ||
        (document.readyState && document.readyState === 'complete')
    ) {
        logAsync(logItem);
    } else {
        logQueueBeforeLoad.push(logItem);
    }
}
```

- **çŸ¥è¯†ç‚¹**ï¼šè¿™é‡Œæˆ‘èŠä¸€ä¸ªçœ‹æºç çš„ä¸€ç‚¹å°ç»éªŒï¼Œå¯¹äºå¾ˆå¤šæºç ä¸­ï¼Œéƒ½æœ‰```if eles```çš„é€»è¾‘å—å­˜åœ¨ï¼Œä¸€èˆ¬å¦‚æœåªæœ‰```if```åˆ†æ”¯ï¼Œè€Œæ²¡æœ‰```else```åˆ†æ”¯çš„é€»è¾‘å—ï¼Œå¤šåŠæ˜¯ç”¨äºåˆ¤æ–­ä¸€äº›ç¯å¢ƒç±»ï¼Œæˆ–è€…éªŒè¯å…¥å‚æ˜¯å¦åˆæ³•ä¹‹ç±»çš„é€»è¾‘ï¼Œä¸€èˆ¬ä¸æ¶‰åŠä¸»é€»è¾‘ï¼Œæ‰€ä»¥è¿™ç±»å’±ä»¬å¯ä»¥ä¸çœ‹ï¼Œç›¸åï¼Œå¦‚æœæ˜¯```if else```çš„è¿™ç§å®Œæ•´çš„é€»è¾‘å—ï¼Œå°±éœ€è¦çœ‹äº†ï¼Œè¿™ç§å®Œæ•´çš„```æ˜¯è¿™ä¸ªå°±è¿™ä¹ˆåšï¼Œä¸æ˜¯è¿™ä¸ªå°±é‚£ä¹ˆåš```ï¼Œçš„é€»è¾‘ï¼Œå°±æ˜¯ä¼šæ¶‰åŠä¸»é€»è¾‘çš„ï¼Œæ‰€ä»¥ä¸€å®šè¦çœ‹ã€‚

æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾ˆæ¸…æ™°çš„å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯å·²ç»åŠ è½½å®Œæˆï¼Œå°±æ‰§è¡ŒlogAsyncæ–¹æ³•ä¼ å…¥logæ•°æ®å»ç”Ÿæˆlogï¼Œå¦‚æœæ˜¯æœªåŠ è½½å®Œæˆçš„çŠ¶æ€ï¼Œåˆ™æŠŠlogæ•°æ®å­˜åˆ°ä¸€ä¸ªæ•°ç»„é‡Œï¼Œç­‰å¾…åç»­å»è°ƒç”¨ã€‚

æ‰€ä»¥æˆ‘ä»¬æ¥ç€çœ‹logAsyncæ–¹æ³• ğŸ‘‰

```typescript
// index.ts

async function logAsync (logItem: LogConfig): Promise<void> {
    // No need to async import if tryTimes exceeds.
    if (LogManager.canSave()) {
        try {
            const saveLogModule = await import(
                /* webpackChunkName: "save_log" */ './save-log'
            );
            saveLogModule.default(logItem);
        } catch (e) {
            LogManager.errorTrigger();
            await (Config.get('errorHandler') as Function)(e);
        }
    } else {
        await (Config.get('errorHandler') as Function)(new Error(ResultMsg.EXCEED_TRY_TIMES));
    }
}
```

å¯ä»¥çœ‹åˆ°æ˜¯ç”± saveLogModule è¿™ä¸ªæ¨¡å—å»æ‰§è¡Œçš„ï¼Œ```saveLogModule.default```å°±æ˜¯è¿™ä¸ªæ¨¡å—çš„é»˜è®¤å¯¼å‡ºã€‚
æ‰€ä»¥æˆ‘ä»¬å»åˆ° save-log.ts

```typescript
import { LogEncryptMode, ResultMsg, LogConfig } from './interface';
import Config from './global-config';
import LoganDB from './lib/logan-db';
import LogManager from './log-manager';
import { invokeInQueue } from './logan-operation-queue';
import * as ENC_UTF8 from 'crypto-js/enc-utf8';
import * as ENC_BASE64 from 'crypto-js/enc-base64';
interface LogStringOb {
    l: string;
    iv?: string;
    k?: string;
    v?: number;
}

let LoganDBInstance: LoganDB;
function base64Encode (text: string): string {
    const textUtf8 = ENC_UTF8.parse(text);
    const textBase64 = textUtf8.toString(ENC_BASE64);
    return textBase64;
}

export default async function saveLog (logConfig: LogConfig): Promise<void> {
    try {
        if (!LogManager.canSave()) {
            throw new Error(ResultMsg.EXCEED_TRY_TIMES);
        }
        if (!LoganDB.idbIsSupported()) {
            throw new Error(ResultMsg.DB_NOT_SUPPORT);
        }
        if (!LoganDBInstance) {
            LoganDBInstance = new LoganDB(Config.get('dbName') as
                | string
                | undefined);
        }
        if (logConfig.encryptVersion === LogEncryptMode.PLAIN) {
            const logStringOb: LogStringOb = {
                l: base64Encode(logConfig.logContent)
            };
            await invokeInQueue(async () => {
                await LoganDBInstance.addLog(
                    JSON.stringify(logStringOb)
                );
            });
        } else if (logConfig.encryptVersion === LogEncryptMode.RSA) {
            const publicKey = Config.get('publicKey');
            const encryptionModule = await import(
                    /* webpackChunkName: "encryption" */ './lib/encryption'
            );
            const cipherOb = encryptionModule.encryptByRSA(
                logConfig.logContent,
                `${publicKey}`
            );
            const logStringOb: LogStringOb = {
                l: cipherOb.cipherText,
                iv: cipherOb.iv,
                k: cipherOb.secretKey,
                v: LogEncryptMode.RSA
            };
            await invokeInQueue(async () => {
                await LoganDBInstance.addLog(
                    JSON.stringify(logStringOb)
                );
            });
        } else {
            throw new Error(`encryptVersion ${logConfig.encryptVersion} is not supported.`);
        }
        await (Config.get('succHandler') as Function)(logConfig);
    } catch (e) {
        LogManager.errorTrigger();
        await (Config.get('errorHandler') as Function)(e);
    }
}

```

æˆ‘è¿™é‡Œæ”¾å‡ºäº†æ•´ä¸ª```save-log.ts```çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¹‹å‰èŠçš„```if else```çš„ç»éªŒæ¥é˜…è¯»ä¸€ä¸‹è¿™éƒ¨åˆ†æºç ï¼Œè¿½å¯»ä¸€ä¸‹ä½œè€…çš„é€»è¾‘æ€è·¯ã€‚

ä¸ºäº†è®©å„ä½æ›´å¥½çš„é˜…è¯»æºç ï¼Œä¸‹é¢æˆ‘åªæŒ‡å‡ºä¸€äº›å…³é”®ä»£ç é€»è¾‘ï¼š

- ```LoganDBInstance.addLog```
- ```LoganDBInstance = new LoganDB(Config.get('dbName'))```

ä»è¿™ä¿©å…³é”®é€»è¾‘ä¸éš¾è¿½æº¯åˆ°```logan-db.ts```è¿™ä¸ªæ–‡ä»¶ã€‚
è¿™ä¸ªæ–‡ä»¶ç”¨```class```å£°æ˜äº†ä¸€ä¸ª```LoganDB```çš„ç±»è¿™é‡Œæˆ‘å°±åªæ”¾å‡ºå…³é”®é€»è¾‘äº†```addLog```

```typescript
// logan-db.ts

async addLog (logString: string): Promise<void> {
        const logSize = sizeOf(logString);
        const now = new Date();
        const today: string = dateFormat2Day(now);
        const todayInfo: LoganLogDayItem = (await this.getLogDayInfo(
            today
        )) || {
            [LOG_DAY_TABLE_PRIMARY_KEY]: today,
            totalSize: 0,
            reportPagesInfo: {
                pageSizes: [0]
            }
        };
        if (todayInfo.totalSize + logSize > DEFAULT_SINGLE_DAY_MAX_SIZE) {
            throw new Error(ResultMsg.EXCEED_LOG_SIZE_LIMIT);
        }
        if (!todayInfo.reportPagesInfo || !todayInfo.reportPagesInfo.pageSizes) {
            todayInfo.reportPagesInfo = { pageSizes: [0] };
        }
        const currentPageSizesArr = todayInfo.reportPagesInfo.pageSizes;
        const currentPageIndex = currentPageSizesArr.length - 1;
        const currentPageSize = currentPageSizesArr[currentPageIndex];
        const needNewPage =
            currentPageSize > 0 &&
            currentPageSize + logSize > DEFAULT_SINGLE_PAGE_MAX_SIZE;
        const nextPageSizesArr = (function (): number[] {
            const arrCopy = currentPageSizesArr.slice();
            if (needNewPage) {
                arrCopy.push(logSize);
            } else {
                arrCopy[currentPageIndex] += logSize;
            }
            return arrCopy;
        })();
        const logItem: LoganLogItem = {
            [LOG_DETAIL_REPORTNAME_INDEX]: this.logReportNameFormatter(
                today,
                needNewPage ? currentPageIndex + 1 : currentPageIndex
            ),
            [LOG_DETAIL_CREATETIME_INDEX]: +now,
            logSize,
            logString
        };
        const updatedTodayInfo: LoganLogDayItem = {
            [LOG_DAY_TABLE_PRIMARY_KEY]: today,
            totalSize: todayInfo.totalSize + logSize,
            reportPagesInfo: {
                pageSizes: nextPageSizesArr
            }
        };
        // The expire time is the start of the day after 7 days.
        const durationBeforeExpired =
            DEFAULT_LOG_DURATION - (+new Date() - getStartOfDay(new Date()));
        await this.DB.addItems([
            {
                tableName: LOG_DAY_TABLE_NAME,
                item: updatedTodayInfo,
                itemDuration: durationBeforeExpired
            },
            {
                tableName: LOG_DETAIL_TABLE_NAME,
                item: logItem,
                itemDuration: durationBeforeExpired
            }
        ]);
    }
```

è¿™é‡Œä¹Ÿæœ‰ä¸€äº›å°çŸ¥è¯†ç‚¹ï¼š

--------------------------

- **çŸ¥è¯†ç‚¹**ï¼š```IIFE```ï¼Œè‡ªæ‰§è¡Œå‡½æ•°å—```(function(){})();```ï¼Œå½“ä½ éœ€è¦æœ‰ä¸€ä¸ªè‡ªæ‰§è¡Œçš„å‡½æ•°çš„æ—¶å€™å°±å¯ä»¥è¿™æ ·å»å†™ï¼Œ```IIFE```ä¹Ÿæ˜¯```webpack```ç­‰æ‰“åŒ…å·¥å…·åœ¨æ‰“åŒ…äº§å‡ºç‰©ä¸­å¸¸ç”¨çš„ä¸€ä¸ªæ¨¡å¼ã€‚

```typescript
// è¿™æ˜¯IIFEåœ¨Loganä»£ç ä¸­çš„ä½¿ç”¨

const nextPageSizesArr = (function (): number[] {
    const arrCopy = currentPageSizesArr.slice();
    if (needNewPage) {
        arrCopy.push(logSize);
    } else {
        arrCopy[currentPageIndex] += logSize;
    }
    return arrCopy;
})();
```

- **çŸ¥è¯†ç‚¹**ï¼š```+new Date()```ï¼Œè¿™é‡Œæœ‰ä¸ªç±»å‹è½¬æ¢çš„å¿«é€Ÿå†™æ³•ï¼Œ```+```å¸¸ç”¨äºå°†```String```ç±»å‹è½¬æ¢ä¸º```Number```ç±»å‹ï¼ŒåŒç†ï¼Œå°†```Number```ç±»å‹ä¹Ÿå¯ä»¥å¿«é€Ÿè½¬æ¢æˆ```String```ç±»å‹ï¼Œé€šè¿‡```+ ''```å³å¯ã€‚æ¯”å¦‚ï¼š```1 + ''```

--------------------------

æ¥å›ä¸»é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹logæ—¥å¿—è¿›è¡Œäº†ï¼Œè¿‡æœŸæ—¶é—´ï¼Œåˆ†é¡µï¼Œlogæ•°æ®å¤§å°ç­‰ç®¡ç†ï¼Œå­˜logæ˜¯å¼•ç”¨äº†å¦ä¸€ä¸ªåŒ…```import { CustomDB, idbIsSupported, deleteDB } from 'idb-managed';```ä¸­çš„```CustomDB```å°±æ˜¯å…·ä½“å­˜çš„äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸ç»§ç»­å»æ·±ç©¶äº†ï¼Œçœ‹```this.DB.addItems```çš„è°ƒç”¨æ–¹å¼ï¼Œå¯ä»¥å¤§èƒ†å»çŒœæµ‹ä¸€ä¸‹ï¼Œåº”è¯¥æ˜¯ç³…åˆäº†æœ‰```localStorage```çš„ç»„åˆæ–¹æ¡ˆï¼Œå½“ç„¶äº†ï¼Œå‰ç«¯æœ¬åœ°å­˜å‚¨çš„æ–¹æ¡ˆï¼Œç»å¯¹ä¸æ­¢è¿™ä¸€ä¸ªï¼Œæ¯”å¦‚ï¼š```indexedDB```ï¼Œè¿˜æœ‰æ®è¯´å³å°†å¼ƒç”¨çš„```WebSQL```ï¼Œ```Service Worker```ç­‰ç­‰ã€‚

okkï¼Œäº†è§£äº†logç”Ÿæˆçš„å­˜å‚¨çš„å®ç°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹logä¸ŠæŠ¥çš„å®ç°å§~ğŸ˜

--------------------------

æˆ‘ä»¬å›åˆ°```index.ts```ä¸­ï¼Œæ‰¾åˆ°```report```æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“è¿½æº¯åˆ°```report-log.ts```æ¨¡å—ï¼š

```typescript
// report-log.ts

import { ReportConfig, ResultMsg, ReportResult, ReportXHROpts } from './interface';
import LoganDB from './lib/logan-db';
import {
    LoganLogDayItem,
    FormattedLogReportName,
    LOG_DAY_TABLE_PRIMARY_KEY
} from './lib/logan-db';
import Config from './global-config';
import Ajax from './lib/ajax';
import { dayFormat2Date, ONE_DAY_TIME_SPAN, dateFormat2Day } from './lib/utils';
import { invokeInQueue } from './logan-operation-queue';
let LoganDBInstance: LoganDB;

/**
 * @returns Promise<number> with reported pageIndex if this page has logs, otherwise Promise<null>.
 */
async function getLogAndSend (reportName: string, reportConfig: ReportConfig): Promise<number | null> {
    const logItems = await LoganDBInstance.getLogsByReportName(reportName);
    if (logItems.length > 0) {
        const pageIndex = LoganDBInstance.logReportNameParser(reportName).pageIndex;
        const logItemStrings = logItems
            .map(logItem => {
                return encodeURIComponent(logItem.logString);
            });
        const logReportOb = LoganDBInstance.logReportNameParser(reportName);
        const customXHROpts: ReportXHROpts = typeof reportConfig.xhrOptsFormatter === 'function' ? reportConfig.xhrOptsFormatter(logItemStrings, logReportOb.pageIndex + 1, logReportOb.logDay) : {};
        return await Ajax(
            customXHROpts.reportUrl || reportConfig.reportUrl || (Config.get('reportUrl') as string),
            customXHROpts.data || JSON.stringify({
                client: 'Web',
                webSource: `${reportConfig.webSource || ''}`,
                deviceId: reportConfig.deviceId,
                environment: `${reportConfig.environment || ''}`,
                customInfo: `${reportConfig.customInfo || ''}`,
                logPageNo: logReportOb.pageIndex + 1, // pageNo start from 1,
                fileDate: logReportOb.logDay,
                logArray: logItems
                    .map(logItem => {
                        return encodeURIComponent(logItem.logString);
                    })
                    .toString()
            }),
            customXHROpts.withCredentials ?? false,
            'POST',
            customXHROpts.headers || {
                'Content-Type': 'application/json',
                'Accept': 'application/json,text/javascript'
            }
        ).then((responseText: any) => {
            if (typeof customXHROpts.responseDealer === 'function') {
                const result = customXHROpts.responseDealer(responseText);
                if (result.resultMsg === ResultMsg.REPORT_LOG_SUCC) {
                    return pageIndex;
                } else {
                    throw new Error(result.desc);
                }
            } else {
                let response;
                try {
                    response = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Try to parse response failed, responseText: ${responseText}`);
                }
                if (response?.code === 200) {
                    return pageIndex;
                } else {
                    throw new Error(`Server error, code: ${response?.code}`);
                }
            }
        });
    } else {
        // Resolve directly if no logs in current page.
        return Promise.resolve(null);
    }
}

export default async function reportLog (
    reportConfig: ReportConfig
): Promise<ReportResult> {
    if (!LoganDB.idbIsSupported()) {
        throw new Error(ResultMsg.DB_NOT_SUPPORT);
    } else {
        if (!LoganDBInstance) {
            LoganDBInstance = new LoganDB(Config.get('dbName') as
                | string
                | undefined);
        }
        return await invokeInQueue(async () => {
            const logDaysInfoList: LoganLogDayItem[] = await LoganDBInstance.getLogDaysInfo(
                reportConfig.fromDayString,
                reportConfig.toDayString
            );
            const logReportMap: {
                [key: string]: FormattedLogReportName[];
            } = logDaysInfoList.reduce((acc, logDayInfo: LoganLogDayItem) => {
                return {
                    [logDayInfo[
                        LOG_DAY_TABLE_PRIMARY_KEY
                    ]]: logDayInfo.reportPagesInfo ? logDayInfo.reportPagesInfo.pageSizes.map((i, pageIndex) => {
                        return LoganDBInstance.logReportNameFormatter(
                            logDayInfo[LOG_DAY_TABLE_PRIMARY_KEY],
                            pageIndex
                        );
                    }) : [],
                    ...acc
                };
            }, {});
            const reportResult: ReportResult = {};
            const startDate = dayFormat2Date(reportConfig.fromDayString);
            const endDate = dayFormat2Date(reportConfig.toDayString);
            for (
                let logTime = +startDate;
                logTime <= +endDate;
                logTime += ONE_DAY_TIME_SPAN
            ) {
                const logDay = dateFormat2Day(new Date(logTime));
                if (logReportMap[logDay] && logReportMap[logDay].length > 0) {
                    try {
                        const batchReportResults = await Promise.all(
                            logReportMap[logDay].map(reportName => {
                                return getLogAndSend(reportName, reportConfig);
                            })
                        );
                        reportResult[logDay] = { msg: ResultMsg.REPORT_LOG_SUCC };
                        try {
                            const reportedPageIndexes = batchReportResults.filter(reportedPageIndex => reportedPageIndex !== null) as number[];
                            if (reportedPageIndexes.length > 0 && reportConfig.incrementalReport) {
                                // Delete logs of reported pages after report.
                                await LoganDBInstance.incrementalDelete(logDay, reportedPageIndexes);
                            }
                        } catch (e) {
                            // Noop if deletion failed.
                        }
                    } catch (e) {
                        reportResult[logDay] = {
                            msg: ResultMsg.REPORT_LOG_FAIL,
                            desc: e.message || e.stack || JSON.stringify(e)
                        };
                    }
                } else {
                    reportResult[logDay] = { msg: ResultMsg.NO_LOG };
                }
            }
            return reportResult;
        });
    }
}
```

å¯ä»¥çœ‹åˆ°åœ¨```getLogAndSend```æ–¹æ³•ä¸­ï¼Œä¸»è¦å°±æ˜¯æ‹¿åˆ°Logsï¼Œè½¬æ¢ä¹‹åï¼Œé€šè¿‡```Ajax```æ–¹æ³•å‘é€æ—¥å¿—çš„ï¼Œæœ€ç»ˆåœ¨utilså†…éƒ¨æœ‰```Ajax```çš„å®ç°ï¼Œå…¶å®ä¹Ÿæ˜¯ç”¨```XMLHttpRequest```å¯¹è±¡å‘é€çš„ã€‚

ç„¶åæˆ‘ä»¬ç€é‡æ¥çœ‹çœ‹è¿™é‡Œï¼š(æˆ‘åˆ æ‰äº†å¾ˆå¤šä»£ç ï¼Œä¸ºäº†è®©ç»“æ„æ›´æ¸…æ™°)

```typescript
// report-log.ts

return await invokeInQueue(async () => {
  const logDaysInfoList: LoganLogDayItem[] = await LoganDBInstance.getLogDaysInfo(
      reportConfig.fromDayString,
      reportConfig.toDayString
  );
  // ç”¨ Map ç»Ÿä¸€ç»´æŠ¤Logsçš„ä¸ŠæŠ¥
  const logReportMap: {
      [key: string]: FormattedLogReportName[];
  } = logDaysInfoList.reduce((acc, logDayInfo: LoganLogDayItem) => {
      
  }, {});
  const reportResult: ReportResult = {};
  const startDate = dayFormat2Date(reportConfig.fromDayString);
  const endDate = dayFormat2Date(reportConfig.toDayString);
  // é€šè¿‡Dateå®ç°åˆ‡åˆ†Logs
  for (
      let logTime = +startDate;
      logTime <= +endDate;
      logTime += ONE_DAY_TIME_SPAN
  ) {
      const logDay = dateFormat2Day(new Date(logTime));
      if (logReportMap[logDay] && logReportMap[logDay].length > 0) {
        // å¹¶è¡Œçš„æ‰¹é‡ä¸Šä¼ 
        const batchReportResults = await Promise.all(
            logReportMap[logDay].map(reportName => {
                return getLogAndSend(reportName, reportConfig);
            })
        );
        reportResult[logDay] = { msg: ResultMsg.REPORT_LOG_SUCC };
        // ä¸ŠæŠ¥æˆåŠŸååˆ é™¤é€»è¾‘
        const reportedPageIndexes = batchReportResults.filter(reportedPageIndex => reportedPageIndex !== null) as number[];
        if (reportedPageIndexes.length > 0 && reportConfig.incrementalReport) {
            // Delete logs of reported pages after report.
            await LoganDBInstance.incrementalDelete(logDay, reportedPageIndexes);
        }
      } else {
        reportResult[logDay] = { msg: ResultMsg.NO_LOG };
      }
  }
  return reportResult;
});
```

```invokeInQueue```è¿™é‡Œé¢çš„```asyncFn: Function```å°±æ˜¯æ ¸å¿ƒä¸ŠæŠ¥é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®çš„é€»è¾‘ï¼Œå¯ä»¥ç”¨ä½œä¸ŠæŠ¥SDKçš„å€Ÿé‰´å’Œå­¦ä¹ 

- **å…³é”®ä¸€**ï¼šæ ¹æ®logç”Ÿæˆçš„Dateæ¥å†³å®šä¸ŠæŠ¥é¡ºåº
- **å…³é”®äºŒ**ï¼šé€šè¿‡ä¸€ä¸ªä¸ŠæŠ¥ç®¡ç†å™¨```logReportMap```æ¥ç®¡ç†ä¸ŠæŠ¥
- **å…³é”®ä¸‰**ï¼šå¹¶è¡Œçš„æ‰¹é‡ä¸Šä¼ ```Promise.all([iterable])```

å½“ç„¶äº†ï¼Œè¿™äº›éƒ½æ˜¯è¿è´¯çš„é€»è¾‘å“ˆï¼Œä¸æ˜¯å•ç‹¬æ‹§å‡ºå»çš„ã€‚

æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªéš¾ç‚¹```invokeInQueue```å‡½æ•°çš„å®ç°ï¼Œæˆ‘ä»¬è¿½æº¯åˆ°```import { invokeInQueue } from './logan-operation-queue';logan-operation-queue.ts```ï¼š

```typescript
// logan-operation-queue.ts

const loganOperationQueue: PromiseItem[] = [];
let operationRunning: boolean = false;
interface PromiseItem {
    asyncF: Function;
    resolution: Function;
    rejection: Function;
}
async function loganOperationsRecursion (): Promise<void> {
  while (loganOperationQueue.length > 0 && !operationRunning) {
    const nextOperation = loganOperationQueue.shift() as PromiseItem;
    operationRunning = true;
    try {
        const result = await nextOperation.asyncF();
        nextOperation.resolution(result);
    } catch (e) {
        nextOperation.rejection(e);
    }
    operationRunning = false; /* eslint-disable-line */ // No need to worry require-atomic-updates here.
    loganOperationsRecursion();
  }
}
export function invokeInQueue (asyncF: Function): Promise<any> {
  return new Promise((resolve, reject) => {
      loganOperationQueue.push({
          asyncF,
          resolution: resolve,
          rejection: reject
      });
      loganOperationsRecursion();
  });
}
/** è¯·å¿½ç•¥ä¸‹é¢è¿™æ®µä»£ç  */
```

æˆ‘ä»¬å…ˆçœ‹```loganOperationsRecursion```å‡½æ•°çš„æ‰§è¡Œé€»è¾‘ï¼š

- æ ¹æ®```loganOperationQueue```æ•°ç»„æ˜¯å¦ä¸ºç©ºå’Œ```operationRunning```æ˜¯å¦ä¸ºfalseæ¥å¾ªç¯ã€‚
- è¿›å…¥å¾ªç¯å†…ï¼Œå–å‡º```loganOperationQueue```çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ³¨æ„```shift()```ä¼šå‡å°æ•°ç»„é•¿åº¦ï¼Œä»è€Œä½¿å¾—å¾ªç¯çš„ç¬¬ä¸€ä¸ªæ¡ä»¶æœ‰è·³å‡ºçš„å¯èƒ½ã€‚
- ä½¿```operationRunning```è¿™ä¸ªçŠ¶æ€ä¸º```true```è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œ
- è°ƒç”¨å–å‡ºæ•°ç»„å…ƒç´ çš„```asyncF```æ–¹æ³•ï¼Œå¹¶æŒ‰è¿”å›ç»“æœæ”¹å˜å…ƒç´ å¯¹åº”çš„çŠ¶æ€ã€‚
- ä½¿```operationRunning```è¿™ä¸ªçŠ¶æ€ä¸º```false```è¡¨ç¤ºæ‰§è¡Œå®Œæˆ
- é€’å½’è°ƒç”¨è‡ªèº«ã€‚

æˆ‘ä»¬å†æ¥çœ‹```invokeInQueue```å‡½æ•°çš„æ‰§è¡Œé€»è¾‘ï¼š

- åˆ›å»º```Promise```å¯¹è±¡ï¼Œå¹¶```return```
- ä¸º```loganOperationQueue```é˜Ÿåˆ—æ·»åŠ å…ƒç´ ï¼Œå¹¶æŠŠå½“å‰```Promise```å¯¹è±¡çš„```resovle```å’Œ```reject```è¿˜æœ‰```invokeInQueue```æœ¬èº«æ¥æ”¶çš„å¼‚æ­¥æ–¹æ³•éƒ½ç»‘åœ¨äº†æ·»åŠ çš„å…ƒç´ ä¸Šã€‚
- æ‰§è¡Œ```loganOperationsRecursion```

è€Œå½“æˆ‘åœ¨```report-log.ts```ä¸­è°ƒç”¨```invokeInQueue```æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºåœ¨```loganOperationsRecursion```ä¸­ï¼Œ```await```çš„å…¶å®æ˜¯```report-log.ts```ä¸­```reportLog```æ–¹æ³•çš„æ‰§è¡Œã€‚

okkï¼Œç”±æ­¤ä¾¿å®Œæˆäº†ä¸ŠæŠ¥æµç¨‹ã€‚

--------------------------

 ğŸ‘‰Loganä¸ä»…ä»…æ˜¯åªæœ‰```WebSDK```ä»–è¿˜æ”¯æŒå…¶ä»–ç«¯ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œgithubï¼Œè¿™é‡Œä»…ä»…ç¬”è€…æµ…è–„çš„çŸ¥è¯†é˜…è¯»```WebSDK```æ¨¡å—ï¼ŒæœŸæœ›è¾¾åˆ°æŠ›ç –å¼•ç‰çš„æ•ˆæœã€‚

--------------------------

ğŸ–¥ï¸å†™åœ¨æœ€åï¼š

*ä»¥ä¸Šå°±æ˜¯å’±ä»¬è¿™æœŸã€å·è£¤è¡©ã€‘çš„å…¨éƒ¨å†…å®¹äº†ï¼Œé˜…è¯»æºç å°±åƒæ˜¯è¯»ä¹¦ï¼Œæ²¿ç€å„ä¸ªæºç ä½œè€…çš„ç¼–ç æ€è·¯è¿›è¡Œæ¢ç´¢çš„è¿‡ç¨‹ï¼Œè¿™æœ‰åŠ©äºå¸®åŠ©è‡ªå·±å·å¸ˆç™¾å®¶ï¼Œæˆä¸ºä»™é“å·…å³°ä¹‹äººã€‚*
